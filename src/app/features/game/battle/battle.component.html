<div class="nebula"></div>
<div class="battle-container">
    <div class="loading-overlay" *ngIf="isContentLoading">
        <div class="loading-spinner"></div>
        <p>Carregando...</p>
    </div>

    <div class="battle-arena" *ngIf="!isContentLoading && battleConfig && enemy && playerCharacter">
        <div class="corner-decoration corner-tl"></div>
        <div class="corner-decoration corner-tr"></div>
        <div class="corner-decoration corner-bl"></div>
        <div class="corner-decoration corner-br"></div>

        <div class="top-hud">
            <h2 class="battle-title">{{ battleConfig.title }}</h2>
            <div class="timer">{{ timerDisplay }}</div>
        </div>

        <button class="exit-button" (click)="onExitBattle()">Sair</button>

        <div class="battle-field">
            <div class="character-container" [class.active-turn]="isPlayerTurn">
                <div class="character-model">
                    <div class="player-avatar">
                        <div class="avatar-frame"></div>
                        <div class="class-icon-display">
                            <img [src]="playerCharacter.class_icon" alt="Ícone da Classe" />
                        </div>
                        <div class="race-icon-display">
                            <img [src]="playerCharacter.race_icon" alt="Ícone da Raça" />
                        </div>
                    </div>
                </div>
                <div class="status-panel">
                    <h3 class="character-name">{{ playerCharacter.name }}</h3>
                    <div class="status-bars">
                        <div class="stat-row">
                            <span class="stat-icon">❤️</span>
                            <div class="stat-bar">
                                <div class="stat-fill health" [style.width.%]="(playerHealth / playerMaxHealth) * 100">
                                    <span class="stat-value">{{ playerHealth }}/{{ playerMaxHealth }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">💪</span>
                            <div class="stat-bar">
                                <div class="stat-fill strength"
                                    [style.width.%]="playerCharacter.attributes.strength * 10"><span
                                        class="stat-value">{{ playerCharacter.attributes.strength }}</span></div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🧠</span>
                            <div class="stat-bar">
                                <div class="stat-fill intelligence"
                                    [style.width.%]="playerCharacter.attributes.intelligence * 10"><span
                                        class="stat-value">{{ playerCharacter.attributes.intelligence }}</span></div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🗣️</span>
                            <div class="stat-bar">
                                <div class="stat-fill charisma"
                                    [style.width.%]="playerCharacter.attributes.charisma * 10"><span
                                        class="stat-value">{{ playerCharacter.attributes.charisma }}</span></div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🎯</span>
                            <div class="stat-bar">
                                <div class="stat-fill dexterity"
                                    [style.width.%]="playerCharacter.attributes.dexterity * 10"><span
                                        class="stat-value">{{ playerCharacter.attributes.dexterity }}</span></div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🌌</span>
                            <div class="stat-bar">
                                <div class="stat-fill intuition"
                                    [style.width.%]="playerCharacter.attributes.intuition * 10"><span
                                        class="stat-value">{{ playerCharacter.attributes.intuition }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="center-stage">
                <div class="chat-container">
                    <div class="chat-header">
                        <h3 class="chat-title">Registro de Combate</h3>
                    </div>
                    <div class="chat-log" #chatLogContainer>
                        <div *ngFor="let entry of dialogHistory" class="chat-message"
                            [ngClass]="{'player-message': entry.speaker === playerCharacter.name, 'enemy-message': entry.speaker !== playerCharacter.name}">
                            <strong class="chat-speaker">{{ entry.speaker }}:</strong>
                            <span class="chat-text">{{ entry.text }}</span>
                        </div>
                        <div *ngIf="isTyping" class="chat-message enemy-message">
                            <strong class="chat-speaker">Narrador:</strong>
                            <span class="generating-text">Gerando<span class="animated-dots"></span></span>
                        </div>
                    </div>
                    <div class="footer-hud" *ngIf="!isBattleOver">
                        <div class="action-input-container">
                            <button class="action-btn-suggestions" title="Sugestões de Ações"
                                (click)="toggleActionPanel()">Ações</button>
                            <input type="text" class="action-input" placeholder="Digite sua ação..."
                                [(ngModel)]="selectedAction" (keyup.enter)="sendPlayerAction()" (focus)="onInputFocus()"
                                (input)="onInputChange()" (click)="onInputClick()"
                                [disabled]="!isPlayerTurn || isLoadingAction">
                            <button class="hud-icon-btn send-btn" title="Enviar Ação" (click)="sendPlayerAction()"
                                [disabled]="!isPlayerTurn || isLoadingAction">
                                <svg fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="enemy-container" [class.active-turn]="!isPlayerTurn">
                <div class="enemy-model">
                    <div class="enemy-visual">
                        <img *ngIf="enemyImageUrl" [src]="enemyImageUrl" [alt]="enemy.name">
                    </div>
                </div>
                <div class="status-panel">
                    <h3 class="character-name">{{ enemy.name }}</h3>
                    <div class="status-bars">
                        <div class="stat-row">
                            <span class="stat-icon">❤️</span>
                            <div class="stat-bar">
                                <div class="stat-fill health" [style.width.%]="(enemyHealth / enemyMaxHealth) * 100">
                                    <span class="stat-value">{{ enemyHealth }}/{{ enemyMaxHealth }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">💪</span>
                            <div class="stat-bar">
                                <div class="stat-fill strength" style="width: 80%"><span class="stat-value">8</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🧠</span>
                            <div class="stat-bar">
                                <div class="stat-fill intelligence" style="width: 60%"><span class="stat-value">6</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🗣️</span>
                            <div class="stat-bar">
                                <div class="stat-fill charisma" style="width: 40%"><span class="stat-value">4</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🎯</span>
                            <div class="stat-bar">
                                <div class="stat-fill dexterity" style="width: 70%"><span class="stat-value">7</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">🌌</span>
                            <div class="stat-bar">
                                <div class="stat-fill intuition" style="width: 90%"><span class="stat-value">9</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-panel" *ngIf="isActionPanelVisible && !isBattleOver">
            <button class="action-btn" *ngFor="let suggestion of actionSuggestions"
                (click)="selectAction(suggestion)">{{ suggestion }}</button>
        </div>


        <div class="battle-over-modal" *ngIf="isBattleOver">
            <div class="modal-content">
                <h2 class="modal-title"
                    [ngClass]="{'victory': battleResult === 'VITÓRIA!', 'defeat': battleResult === 'DERROTA!'}">{{
                    battleResult }}</h2>
                <p class="modal-text">{{ battleResult === 'VITÓRIA!' ? 'Você superou o desafio e se tornou mais forte.'
                    : 'A jornada é longa. Reagrupe-se e tente novamente.' }}</p>
                <button class="modal-button" (click)="returnToMap()">Voltar ao Mapa Galáctico</button>
            </div>
        </div>
    </div>
</div>